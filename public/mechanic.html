<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigRed Workshop - Tickets</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Mechanic interface for BigRed Workshop ticket management">
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BigRed Mechanic">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="manifest" href="/manifest.webmanifest">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./admin.css">
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="mechanic-app">
        <!-- Header -->
        <div class="admin-header">
            <div class="container mx-auto px-4 flex items-center justify-between">
                <div class="flex items-center gap-4 flex-1">
                    <h1 class="flex items-center gap-3">
                        <i data-lucide="wrench" class="w-8 h-8 text-red-500"></i>
                        <span>Mechanic</span>
                    </h1>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500">Logged in as: </span>
                        <span id="userNameBadge" class="badge badge-info">—</span>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <button id="logoutBtn" type="button" class="btn btn-danger">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-6">
            <!-- Filters Card -->
            <div class="card mb-6">
                <div class="card-title">
                    <i data-lucide="filter" class="w-6 h-6"></i>
                    Filters
                </div>
                
                <form id="filtersForm" class="filter-bar">
                    <div class="filter-group">
                        <label for="filterStatus" class="filter-label">Status</label>
                        <select id="filterStatus" class="filter-select">
                            <option value="ALL" selected>All Statuses</option>
                            <option value="open">open</option>
                            <option value="in_progress">in progress</option>
                            <option value="done">done</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterPriority" class="filter-label">Priority</label>
                        <select id="filterPriority" class="filter-select">
                            <option value="ALL" selected>All Priorities</option>
                            <option value="low">low</option>
                            <option value="medium">medium</option>
                            <option value="high">high</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button id="addTicketBtn" type="button" class="btn btn-primary">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Ticket
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tickets Cards -->
            <div class="card mb-6">
                <div class="card-title">
                    <i data-lucide="ticket" class="w-6 h-6"></i>
                    My Tickets
                </div>
                <div id="cards" class="space-y-4"></div>
                <div class="flex justify-center mt-6">
                    <button id="loadMore" class="btn btn-primary">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Load more
                    </button>
                </div>
            </div>

            <!-- Dealer visit section -->
            <div id="dealer-mech" class="card mb-6">
                <div class="card-title">
                    <i data-lucide="building" class="w-6 h-6"></i>
                    Dealer Visit
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="form-group">
                        <label for="dealer-mech-buggy" class="form-label">Buggy</label>
                        <select id="dealer-mech-buggy" class="form-select">
                            <option value="">Select buggy…</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dealer-mech-issue" class="form-label">Issue</label>
                        <input id="dealer-mech-issue" class="form-input" placeholder="e.g. gearbox noise" />
                    </div>
                </div>

                <div class="flex items-center gap-3 mb-4">
                    <button id="dealer-mech-give-btn" class="btn btn-primary">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Give to dealer
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">My active at dealer</h3>
                    <ul id="dealer-mech-active-list" class="space-y-2"></ul>
                </div>
            </div>

            <div id="dealer-active" class="space-y-3">
                <!-- Active dealer visits will appear here -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="ticketModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="createTicketTitle" hidden>
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="createTicketTitle" class="modal-title">New Ticket</h3>
                <button type="button" class="modal-close" data-modal-cancel="ticketModal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="m_buggy" class="form-label">Buggy</label>
                        <select id="m_buggy" class="form-select">
                            <option value="">— No buggy —</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m_priority" class="form-label">Priority</label>
                        <select id="m_priority" class="form-select">
                            <option value="low">low</option>
                            <option value="medium" selected>medium</option>
                            <option value="high">high</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="m_desc" class="form-label">Description</label>
                        <input id="m_desc" placeholder="e.g. oil change" class="form-input" />
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" data-modal-cancel="ticketModal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="m_save">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Create
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastWrap" class="toast-container"></div>
    
    <!-- Supabase client with persistent session -->
    <script type="module" src="/supabase.js"></script>
    <script type="module" src="./app.js"></script>
    
    <!-- PWA Scripts -->
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(r => console.log('[PWA] SW registered', r.scope))
        .catch(err => console.error('[PWA] SW register error', err));
    }
    </script>
    <script src="/pwa-install.js"></script>
    
    <!-- Initialize Lucide icons -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
    </script>
</body>
</html>
